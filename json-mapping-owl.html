<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JSON Mapping Prototype - OWL</title>
    <!-- Odoo OWL 2.x from official CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@odoo/owl@2.8.1/dist/owl.iife.min.js"></script>
    <style>
      :root {
        --bg-primary: #1a1a1a;
        --bg-secondary: #262626;
        --bg-tertiary: #333333;
        --border-color: #444444;
        --text-primary: #ffffff;
        --text-secondary: #a0a0a0;
        --text-muted: #666666;
        --accent-green: #00c853;
        --accent-blue: #2196f3;
        --accent-orange: #ff9800;
        --json-key: #9cdcfe;
        --json-string: #ce9178;
        --json-number: #b5cea8;
        --json-boolean: #569cd6;
        --json-null: #808080;
        --drop-zone-active: rgba(33, 150, 243, 0.2);
        --drop-zone-hover: rgba(0, 200, 83, 0.3);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        height: 100vh;
        overflow: hidden;
      }

      .app-container {
        display: flex;
        height: 100vh;
        gap: 1px;
        background: var(--border-color);
      }

      /* Panel */
      .panel {
        flex: 1;
        background: var(--bg-secondary);
        display: flex;
        flex-direction: column;
        min-width: 0;
      }

      .panel-header {
        background: var(--bg-tertiary);
        padding: 12px 16px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .panel-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .panel-badge {
        background: var(--accent-green);
        color: var(--bg-primary);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 600;
      }

      .panel-tabs {
        display: flex;
        gap: 4px;
        margin-left: auto;
      }

      .panel-tab {
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        background: transparent;
        color: var(--text-secondary);
        border: none;
        transition: all 0.15s;
      }

      .panel-tab.active {
        background: var(--bg-primary);
        color: var(--text-primary);
      }

      .panel-tab:hover:not(.active) {
        background: var(--bg-primary);
        opacity: 0.7;
      }

      .panel-content {
        flex: 1;
        overflow: auto;
        padding: 16px;
      }

      /* JSON Tree */
      .json-tree {
        font-family: "Consolas", "Monaco", "Courier New", monospace;
        font-size: 13px;
        line-height: 1.6;
      }

      .json-node {
        padding-left: 20px;
        position: relative;
      }

      .json-node::before {
        content: "";
        position: absolute;
        left: 8px;
        top: 0;
        bottom: 0;
        width: 1px;
        background: var(--border-color);
      }

      .json-line {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 2px 4px;
        border-radius: 3px;
        cursor: default;
      }

      .json-line.draggable {
        cursor: grab;
      }

      .json-line.draggable:hover {
        background: var(--drop-zone-active);
      }

      .json-line.dragging {
        opacity: 0.5;
        background: var(--accent-blue);
      }

      .json-expand {
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--text-muted);
        font-size: 10px;
      }

      .json-expand:hover {
        color: var(--text-primary);
      }

      .json-key {
        color: var(--json-key);
      }

      .json-colon {
        color: var(--text-muted);
      }

      .json-value.string {
        color: var(--json-string);
      }
      .json-value.number {
        color: var(--json-number);
      }
      .json-value.boolean {
        color: var(--json-boolean);
      }
      .json-value.null {
        color: var(--json-null);
      }

      .json-bracket {
        color: var(--text-muted);
      }

      .json-length {
        color: var(--text-muted);
        font-size: 11px;
        margin-left: 4px;
      }

      /* Drop Area */
      .drop-area {
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        padding: 24px;
        text-align: center;
        transition: all 0.2s;
        min-height: 120px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .drop-area.droppable {
        border-color: var(--accent-blue);
        background: var(--drop-zone-active);
      }

      .drop-area.active {
        border-color: var(--accent-green);
        background: var(--drop-zone-hover);
      }

      .drop-area-text {
        color: var(--text-secondary);
        font-size: 13px;
      }

      .drop-area-hint {
        color: var(--text-muted);
        font-size: 12px;
      }

      .drop-area-add {
        color: var(--accent-blue);
        font-weight: 600;
        cursor: pointer;
      }

      /* Field Assignments */
      .field-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 16px;
      }

      .field-item {
        display: flex;
        align-items: center;
        gap: 8px;
        background: var(--bg-tertiary);
        border-radius: 6px;
        padding: 8px 12px;
        border: 1px solid var(--border-color);
      }

      .field-drag-handle {
        color: var(--text-muted);
        cursor: grab;
        padding: 4px;
      }

      .field-name {
        flex: 1;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 6px 10px;
        color: var(--text-primary);
        font-size: 13px;
      }

      .field-type {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 6px 10px;
        color: var(--text-secondary);
        font-size: 12px;
        min-width: 80px;
      }

      .field-value {
        flex: 2;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 6px 10px;
        color: var(--accent-orange);
        font-size: 13px;
        font-family: "Consolas", monospace;
      }

      .field-remove {
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 4px;
        font-size: 16px;
        line-height: 1;
      }

      .field-remove:hover {
        color: #ff5252;
      }

      /* Drag Ghost */
      .drag-ghost {
        position: fixed;
        pointer-events: none;
        z-index: 9999;
        background: var(--accent-blue);
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        white-space: nowrap;
      }

      /* Section Title */
      .section-title {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: var(--bg-primary);
      }

      ::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: var(--text-muted);
      }
    </style>
  </head>
  <body>
    <div id="app"></div>

    <script>
      const { Component, xml, useState, useRef, onMounted, onWillUnmount } =
        owl;

      // ============================================
      // DRAG STATE STORE (like NDV Store in n8n)
      // ============================================
      const dragStore = {
        state: {
          isDragging: false,
          type: "",
          data: "",
          path: "",
          dimensions: null,
          position: [0, 0],
          activeTarget: null,
        },
        listeners: new Set(),

        subscribe(fn) {
          this.listeners.add(fn);
          return () => this.listeners.delete(fn);
        },

        notify() {
          this.listeners.forEach((fn) => fn(this.state));
        },

        startDragging({ type, data, path, dimensions }) {
          this.state = {
            ...this.state,
            isDragging: true,
            type,
            data,
            path,
            dimensions,
          };
          this.notify();
        },

        updatePosition(x, y) {
          this.state.position = [x, y];
          this.notify();
        },

        setActiveTarget(target) {
          this.state.activeTarget = target;
          this.notify();
        },

        stopDragging() {
          this.state = {
            isDragging: false,
            type: "",
            data: "",
            path: "",
            dimensions: null,
            position: [0, 0],
            activeTarget: null,
          };
          this.notify();
        },
      };

      // ============================================
      // JSON TREE NODE COMPONENT
      // ============================================
      class JsonTreeNode extends Component {
        static template = xml`
                <div class="json-node">
                    <div t-attf-class="json-line {{ isObject or isArray ? '' : 'draggable' }} {{ state.dragging ? 'dragging' : '' }}"
                         t-on-mousedown="onMouseDown"
                         t-att-data-path="props.path"
                         t-att-data-value="expressionValue">
                        <span t-if="isObject or isArray" class="json-expand" t-on-click="toggleExpand">
                            {{ state.expanded ? '▼' : '▶' }}
                        </span>
                        <span t-else="" style="width: 16px; display: inline-block;"></span>
                        
                        <span class="json-key">"{{ props.keyName }}"</span>
                        <span class="json-colon">:</span>
                        
                        <t t-if="isObject">
                            <span class="json-bracket">{</span>
                            <span class="json-length">{{ objectKeys.length }} keys</span>
                            <span t-if="!state.expanded" class="json-bracket">}</span>
                        </t>
                        <t t-elif="isArray">
                            <span class="json-bracket">[</span>
                            <span class="json-length">{{ props.value.length }} items</span>
                            <span t-if="!state.expanded" class="json-bracket">]</span>
                        </t>
                        <t t-else="">
                            <span t-attf-class="json-value {{ valueType }}">{{ displayValue }}</span>
                        </t>
                    </div>
                    
                    <t t-if="(isObject or isArray) and state.expanded">
                        <t t-if="isObject">
                            <t t-foreach="objectKeys" t-as="key" t-key="key">
                                <JsonTreeNode 
                                    keyName="key" 
                                    value="props.value[key]"
                                    path="props.path + '.' + key"
                                    depth="props.depth + 1"/>
                            </t>
                        </t>
                        <t t-if="isArray">
                            <t t-foreach="props.value" t-as="item" t-key="item_index">
                                <JsonTreeNode 
                                    keyName="item_index" 
                                    value="item"
                                    path="props.path + '[' + item_index + ']'"
                                    depth="props.depth + 1"/>
                            </t>
                        </t>
                        <div class="json-line" style="padding-left: 20px;">
                            <span class="json-bracket" t-if="isObject">}</span>
                            <span class="json-bracket" t-if="isArray">]</span>
                        </div>
                    </t>
                </div>
            `;

        static components = { JsonTreeNode };
        static props = ["keyName", "value", "path", "depth"];

        setup() {
          this.state = useState({
            expanded: this.props.depth < 2,
            dragging: false,
          });
        }

        get isObject() {
          return (
            this.props.value !== null &&
            typeof this.props.value === "object" &&
            !Array.isArray(this.props.value)
          );
        }

        get isArray() {
          return Array.isArray(this.props.value);
        }

        get objectKeys() {
          return this.isObject ? Object.keys(this.props.value) : [];
        }

        get valueType() {
          const v = this.props.value;
          if (v === null) return "null";
          if (typeof v === "string") return "string";
          if (typeof v === "number") return "number";
          if (typeof v === "boolean") return "boolean";
          return "string";
        }

        get displayValue() {
          const v = this.props.value;
          if (v === null) return "null";
          if (typeof v === "string") return `"${v}"`;
          return String(v);
        }

        get expressionValue() {
          return `{{ $json${this.props.path} }}`;
        }

        toggleExpand() {
          this.state.expanded = !this.state.expanded;
        }

        onMouseDown(ev) {
          if (this.isObject || this.isArray) return;

          ev.preventDefault();
          this.state.dragging = true;

          const expression = this.expressionValue;
          const rect = ev.target.getBoundingClientRect();

          dragStore.startDragging({
            type: "mapping",
            data: expression,
            path: this.props.path,
            dimensions: rect,
          });

          const onMouseMove = (e) => {
            dragStore.updatePosition(e.pageX, e.pageY);
          };

          const onMouseUp = () => {
            this.state.dragging = false;
            dragStore.stopDragging();
            window.removeEventListener("mousemove", onMouseMove);
            window.removeEventListener("mouseup", onMouseUp);
          };

          window.addEventListener("mousemove", onMouseMove);
          window.addEventListener("mouseup", onMouseUp);
        }
      }

      // ============================================
      // JSON TREE VIEWER COMPONENT
      // ============================================
      class JsonTreeViewer extends Component {
        static template = xml`
                <div class="json-tree">
                    <div class="json-line">
                        <span class="json-bracket">{</span>
                    </div>
                    <t t-foreach="objectKeys" t-as="key" t-key="key">
                        <JsonTreeNode 
                            keyName="key" 
                            value="props.data[key]"
                            path="'.' + key"
                            depth="0"/>
                    </t>
                    <div class="json-line">
                        <span class="json-bracket">}</span>
                    </div>
                </div>
            `;

        static components = { JsonTreeNode };
        static props = ["data"];

        get objectKeys() {
          return Object.keys(this.props.data || {});
        }
      }

      // ============================================
      // DROP AREA COMPONENT
      // ============================================
      class DropArea extends Component {
        static template = xml`
                <div t-attf-class="drop-area {{ state.droppable ? 'droppable' : '' }} {{ state.active ? 'active' : '' }}"
                     t-on-mouseenter="onMouseEnter"
                     t-on-mouseleave="onMouseLeave"
                     t-on-mouseup="onMouseUp">
                    <t t-if="state.active">
                        <span class="drop-area-text">Drop to add field</span>
                        <span class="drop-area-hint" style="color: var(--accent-green); font-weight: 600;">{{ state.fieldName }}</span>
                    </t>
                    <t t-elif="state.droppable">
                        <span class="drop-area-text">Drop field here</span>
                        <span class="drop-area-hint" style="color: var(--accent-blue);">{{ state.fieldName }}</span>
                    </t>
                    <t t-else="">
                        <span class="drop-area-text">Drag input fields here</span>
                        <span class="drop-area-hint">or <span class="drop-area-add" t-on-click="onAddClick">Add Field</span></span>
                    </t>
                </div>
            `;

        static props = ["onDrop"];

        setup() {
          this.state = useState({
            droppable: false,
            active: false,
            fieldName: "",
          });

          this.unsubscribe = dragStore.subscribe((dragState) => {
            this.state.droppable =
              dragState.isDragging && dragState.type === "mapping";
            if (dragState.path) {
              this.state.fieldName = dragState.path.replace(/^\./, "");
            }
          });

          onWillUnmount(() => {
            this.unsubscribe();
          });
        }

        onMouseEnter() {
          if (dragStore.state.isDragging) {
            this.state.active = true;
            dragStore.setActiveTarget(this);
          }
        }

        onMouseLeave() {
          this.state.active = false;
          if (dragStore.state.activeTarget === this) {
            dragStore.setActiveTarget(null);
          }
        }

        onMouseUp() {
          if (this.state.active && dragStore.state.isDragging) {
            const data = dragStore.state.data;
            const path = dragStore.state.path;
            this.props.onDrop({ expression: data, path });
          }
          this.state.active = false;
        }

        onAddClick() {
          this.props.onDrop({ expression: "", path: "", manual: true });
        }
      }

      // ============================================
      // FIELD ITEM COMPONENT
      // ============================================
      class FieldItem extends Component {
        static template = xml`
                <div class="field-item">
                    <span class="field-drag-handle">⠿</span>
                    <input class="field-name" 
                           t-att-value="props.field.name" 
                           t-on-input="onNameChange"
                           placeholder="Field name"/>
                    <select class="field-type" t-on-change="onTypeChange">
                        <option value="string" t-att-selected="props.field.type === 'string'">String</option>
                        <option value="number" t-att-selected="props.field.type === 'number'">Number</option>
                        <option value="boolean" t-att-selected="props.field.type === 'boolean'">Boolean</option>
                        <option value="object" t-att-selected="props.field.type === 'object'">Object</option>
                    </select>
                    <input class="field-value" 
                           t-att-value="props.field.value" 
                           t-on-input="onValueChange"
                           placeholder="Value or expression"/>
                    <button class="field-remove" t-on-click="onRemove">×</button>
                </div>
            `;

        static props = ["field", "index", "onUpdate", "onRemove"];

        onNameChange(ev) {
          this.props.onUpdate(this.props.index, {
            ...this.props.field,
            name: ev.target.value,
          });
        }

        onTypeChange(ev) {
          this.props.onUpdate(this.props.index, {
            ...this.props.field,
            type: ev.target.value,
          });
        }

        onValueChange(ev) {
          this.props.onUpdate(this.props.index, {
            ...this.props.field,
            value: ev.target.value,
          });
        }

        onRemove() {
          this.props.onRemove(this.props.index);
        }
      }

      // ============================================
      // DRAG GHOST COMPONENT
      // ============================================
      class DragGhost extends Component {
        static template = xml`
                <div t-if="state.visible" 
                     class="drag-ghost"
                     t-attf-style="left: {{ state.x }}px; top: {{ state.y }}px;">
                    {{ state.label }}
                </div>
            `;

        setup() {
          this.state = useState({
            visible: false,
            x: 0,
            y: 0,
            label: "",
          });

          this.unsubscribe = dragStore.subscribe((dragState) => {
            this.state.visible = dragState.isDragging;
            this.state.x = dragState.position[0] + 10;
            this.state.y = dragState.position[1] + 10;
            this.state.label = dragState.path
              ? dragState.path.replace(/^\./, "")
              : "";
          });

          onWillUnmount(() => {
            this.unsubscribe();
          });
        }
      }

      // ============================================
      // MAIN APP COMPONENT
      // ============================================
      class App extends Component {
        static template = xml`
                <div class="app-container">
                    <!-- INPUT Panel (Left) -->
                    <div class="panel">
                        <div class="panel-header">
                            <span class="panel-title">INPUT</span>
                            <span class="panel-badge">{{ itemCount }} items</span>
                            <div class="panel-tabs">
                                <button class="panel-tab" t-attf-class="{{ state.inputView === 'schema' ? 'active' : '' }}" 
                                        t-on-click="() => this.state.inputView = 'schema'">Schema</button>
                                <button class="panel-tab" t-attf-class="{{ state.inputView === 'table' ? 'active' : '' }}"
                                        t-on-click="() => this.state.inputView = 'table'">Table</button>
                                <button class="panel-tab" t-attf-class="{{ state.inputView === 'json' ? 'active' : '' }}"
                                        t-on-click="() => this.state.inputView = 'json'">JSON</button>
                            </div>
                        </div>
                        <div class="panel-content">
                            <JsonTreeViewer data="sampleData"/>
                        </div>
                    </div>

                    <!-- OUTPUT Panel (Right) -->
                    <div class="panel">
                        <div class="panel-header">
                            <span class="panel-title">MAPPING</span>
                            <div class="panel-tabs">
                                <button class="panel-tab active">Manual</button>
                                <button class="panel-tab">JSON</button>
                            </div>
                        </div>
                        <div class="panel-content">
                            <div class="section-title">Fields to Set</div>
                            
                            <div class="field-list">
                                <t t-foreach="state.fields" t-as="field" t-key="field.id">
                                    <FieldItem 
                                        field="field" 
                                        index="field_index"
                                        onUpdate.bind="updateField"
                                        onRemove.bind="removeField"/>
                                </t>
                            </div>

                            <DropArea onDrop.bind="handleDrop"/>
                        </div>
                    </div>

                    <!-- Drag Ghost (Teleported) -->
                    <DragGhost/>
                </div>
            `;

        static components = { JsonTreeViewer, DropArea, FieldItem, DragGhost };

        setup() {
          this.state = useState({
            inputView: "json",
            fields: [],
          });

          this.sampleData = {
            postId: 1,
            id: 1,
            name: "id labore ex et quam laborum",
            email: "Eliseo@gardner.biz",
            body: "laudantium enim quasi est quidem magnam voluptate ipsam eos",
            user: {
              firstName: "John",
              lastName: "Doe",
              age: 30,
            },
            tags: ["javascript", "typescript", "owl"],
          };
        }

        get itemCount() {
          return 5;
        }

        handleDrop({ expression, path, manual }) {
          const fieldName = path
            ? path.replace(/^\./, "").split(".").pop()
            : "";

          this.state.fields.push({
            id: Date.now(),
            name: fieldName,
            type: "string",
            value: expression,
          });
        }

        updateField(index, newField) {
          this.state.fields[index] = newField;
        }

        removeField(index) {
          this.state.fields.splice(index, 1);
        }
      }

      // Mount the app
      owl.mount(App, document.getElementById("app"));
    </script>
  </body>
</html>
